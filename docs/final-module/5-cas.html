<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>C Assembly</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script src="http://code.jquery.com/jquery-1.12.4.min.js"
	integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>

<script src="../docs-assets/Bigfoot.js"></script>
<link href="../docs-assets/Bigfoot.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<h1><a href="../index.html"><img src="../docs-assets/Inform.png" height=72> </a></h1>
<ul><li><a href="../index.html">home</a></li>
</ul><h2>Compiler</h2><ul>
<li><a href="../structure.html">structure</a></li>
<li><a href="../inbuildn.html">inbuild</a></li>
<li><a href="../inform7n.html">inform7</a></li>
<li><a href="../intern.html">inter</a></li>
<li><a href="../services.html">services</a></li>
<li><a href="../secrets.html">secrets</a></li>
</ul><h2>Other Tools</h2><ul>
<li><a href="../inblorbn.html">inblorb</a></li>
<li><a href="../inform6.html">inform6</a></li>
<li><a href="../inpolicyn.html">inpolicy</a></li>
</ul><h2>Resources</h2><ul>
<li><a href="../extensions.html">extensions</a></li>
<li><a href="../kits.html">kits</a></li>
</ul><h2>Repository</h2><ul>
<li><a href="https://github.com/ganelson/inform"><img src="../docs-assets/github.png" height=0> github</a></li>
</ul><h2>Related Projects</h2><ul>
<li><a href="https://github.com/ganelson/inweb"><img src="../docs-assets/github.png" height=0> inweb</a></li>
<li><a href="https://github.com/ganelson/intest"><img src="../docs-assets/github.png" height=0> intest</a></li>
</ul>
		</nav>
		<main role="main">
		<!-- Weave of 'C Assembly' generated by inweb -->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="../intern.html">Inter Modules</a></li><li><a href="index.html">final</a></li><li><a href="index.html#5">Chapter 5: C</a></li><li><b>C Assembly</b></li></ul></div>
<p class="purpose">The problem of assembly language.</p>

<ul class="toc"><li><a href="5-cas.html#SP1">&#167;1. General implementation</a></li><li><a href="5-cas.html#SP8">&#167;8. call</a></li><li><a href="5-cas.html#SP9">&#167;9. copy</a></li><li><a href="5-cas.html#SP10">&#167;10. aload, aloads, aloadb</a></li><li><a href="5-cas.html#SP11">&#167;11. ushiftr, shiftl</a></li><li><a href="5-cas.html#SP12">&#167;12. jeq, jleu, jnz, jz</a></li><li><a href="5-cas.html#SP13">&#167;13. nop, quit, verify</a></li><li><a href="5-cas.html#SP14">&#167;14. restoreundo, saveundo, hasundo, discardundo</a></li><li><a href="5-cas.html#SP15">&#167;15. restart, restore, save</a></li><li><a href="5-cas.html#SP16">&#167;16. streamchar, streamnum, streamunichar</a></li><li><a href="5-cas.html#SP17">&#167;17. binarysearch</a></li><li><a href="5-cas.html#SP18">&#167;18. mcopy, mzero, malloc, mfree</a></li><li><a href="5-cas.html#SP19">&#167;19. random, setrandom</a></li><li><a href="5-cas.html#SP20">&#167;20. setiosys</a></li><li><a href="5-cas.html#SP21">&#167;21. gestalt</a></li></ul><hr class="tocbar">

<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. General implementation.</b>  This section does just one thing: compiles invocations of assembly-language
opcodes.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">CAssembly::initialise</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="function-syntax">CAssembly::initialise</span></span>:<br/>Final C - <a href="5-fnc.html#SP1">&#167;1</a></span></button><span class="plain-syntax">(</span><span class="type-syntax">code_generator</span><span class="plain-syntax"> *</span><span class="identifier-syntax">gtr</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">METHOD_ADD</span><span class="plain-syntax">(</span><span class="identifier-syntax">gtr</span><span class="plain-syntax">, </span><span class="constant-syntax">INVOKE_OPCODE_MTID</span><span class="plain-syntax">, </span><a href="5-cas.html#SP6" class="function-link"><span class="function-syntax">CAssembly::invoke_opcode</span></a><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">METHOD_ADD</span><span class="plain-syntax">(</span><span class="identifier-syntax">gtr</span><span class="plain-syntax">, </span><span class="constant-syntax">ASSEMBLY_MARKER_MTID</span><span class="plain-syntax">, </span><a href="5-cas.html#SP7" class="function-link"><span class="function-syntax">CAssembly::assembly_marker</span></a><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="type-syntax">struct</span><span class="plain-syntax"> </span><span class="type-syntax">C_generation_assembly_data</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="type-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">dictionary</span><span class="plain-syntax"> *</span><span class="identifier-syntax">opcodes_used</span><span class="plain-syntax">;</span>
<span class="plain-syntax">} </span><span class="type-syntax">C_generation_assembly_data</span><span class="plain-syntax">;</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">CAssembly::initialise_data</span><button class="popup" onclick="togglePopup('usagePopup2')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup2">Usage of <span class="code-font"><span class="function-syntax">CAssembly::initialise_data</span></span>:<br/>Final C - <a href="5-fnc.html#SP4">&#167;4</a></span></button><span class="plain-syntax">(</span><span class="type-syntax">code_generation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">gen</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">C_GEN_DATA</span><span class="plain-syntax">(</span><span class="identifier-syntax">asmdata</span><span class="plain-syntax">.</span><span class="element-syntax">opcodes_used</span><span class="plain-syntax">) = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">CAssembly::begin</span><button class="popup" onclick="togglePopup('usagePopup3')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup3">Usage of <span class="code-font"><span class="function-syntax">CAssembly::begin</span></span>:<br/>Final C - <a href="5-fnc.html#SP5">&#167;5</a></span></button><span class="plain-syntax">(</span><span class="type-syntax">code_generation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">gen</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP1" class="function-link"><span class="function-syntax">CAssembly::initialise_data</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">CAssembly::end</span><button class="popup" onclick="togglePopup('usagePopup4')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup4">Usage of <span class="code-font"><span class="function-syntax">CAssembly::end</span></span>:<br/>Final C - <a href="5-fnc.html#SP6">&#167;6</a></span></button><span class="plain-syntax">(</span><span class="type-syntax">code_generation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">gen</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>The structure C_generation_assembly_data is private to this section.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP2" class="paragraph-anchor"></a><b>&#167;2. </b>  Inter is for the most part fully specified and cross-platform, but assembly
language is the big hole in that. It is legal for Inter code to contain almost
anything which purports to be assembly language. For example, the following
code will successfully build as part of an Inter kit:</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    [ </span><span class="identifier-syntax">Peculiar</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        @</span><span class="identifier-syntax">bandersnatch</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    ];</span>
</pre>
<div class="lsmarkdown">
<p>Kit code, and also material included in <code>(-</code> and <code>-)</code> brackets in I7 source text,
can claim to use assembly language opcodes with any names it likes. No checking
is done that these are &quot;real&quot; opcodes. (Spoilers: <code>@bandersnatch</code> is not.)</p>
<p>The point of this is that different final targets support different sets of
assembly language. This was always true for Inform 6 code (after around 2000,
anyway), because the Z and Glulx virtual machines had different assembly
languages: <code>@split_window</code> exists for Z but not Glulx, <code>@atan</code> exists for
Glulx but not Z, for example.</p>
<p>So each different final generator needs to make its own decision about what
assembly language opcodes to provide, and what they will do. In theory, we could
make an entirely new assembly language for C. But in practice that would just
make the standard Inform kits, such as BasicInformKit, impossible to support
on C, because those kits make quite heavy use of opcodes from Z/Glulx.</p>
<p>We will instead:</p>
<ul>
<li>Emulate exactly that subset of the Glulx assembly language which is used
by the standard Inform kits, and</li>
<li>Allow any other opcodes to be externally defined by the user.</li>
</ul>
<p>In this way, we obtain both compatibility with the Inform kits, enabling us to
compile works of IF to C, and also extensibility.</p>
</div>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP3" class="paragraph-anchor"></a><b>&#167;3. </b>  Each different opcode we see will be matched up to a <a href="5-cas.html#SP3" class="internal">C_supported_opcode</a>
giving it some metadata: we will gather these into a dictionary so that names
of opcodes can quickly be resolved to their metadata structures.</p>
<p>That dictionary will begin with (1) about 60 standard supported opcodes, but
then may pick up (2) a few others such as <code>@bandersnatch</code>, if kits do something
non-standard.</p>
<p>So now we define some very minimal metadata on our opcodes. Each opcode will,
when used, be followed by a number of operands, which we number from 1:</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    @</span><span class="identifier-syntax">fmod</span><span class="plain-syntax"> </span><span class="identifier-syntax">a</span><span class="plain-syntax"> </span><span class="identifier-syntax">b</span><span class="plain-syntax"> </span><span class="identifier-syntax">rem</span><span class="plain-syntax"> </span><span class="identifier-syntax">quot</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="comment-syntax">!     1 2 3   4</span>
</pre>
<div class="lsmarkdown">
<p>This opcode, which performs floating-point division with remainder, reads in
operands 1 and 2, and writes results out to operands 3 and 4. In the following,
<code>store_this_operand[3]</code> and <code>store_this_operand[4]</code> would be <code>TRUE</code>, while
<code>store_this_operand[1]</code> and <code>store_this_operand[2]</code> would be <code>FALSE</code>. (In fact,
this is an outlier, because it is the only opcode we support which has more than
one store operand. But in principle we could have many.)</p>
<p>Glulx assembly language also allows variable numbers of arguments to some opcodes,
or &quot;varargs&quot;. For example:</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    @</span><span class="identifier-syntax">glk</span><span class="plain-syntax"> </span><span class="constant-syntax">4</span><span class="plain-syntax"> </span><span class="identifier-syntax">_vararg_count</span><span class="plain-syntax"> </span><span class="identifier-syntax">ret</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="comment-syntax">!    1 2             3</span>
</pre>
<div class="lsmarkdown">
<p>Here operand 3 is a store, and operands 1 and 2 are read in. But operand 2 is
special in that it is a count of additional operands which are found on the
stack rather than in the body of the instruction. For example,</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    @</span><span class="identifier-syntax">glk</span><span class="plain-syntax"> </span><span class="constant-syntax">4</span><span class="plain-syntax"> </span><span class="constant-syntax">6</span><span class="plain-syntax"> </span><span class="identifier-syntax">ret</span><span class="plain-syntax">;</span>
</pre>
<div class="lsmarkdown">
<p>would provide <code>@glk</code> with seven operands to read in: the one in the instruction
itself, <code>4</code>, and then the top 6 items on the stack.</p>
<p>Because of this, an operand holding a variable-argument count is special. There
can be at most one for any opcode; <code>vararg_operand</code> is -1 if there isn't one,
but for <code>@glk</code>, <code>vararg_operand</code> would be 2.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="type-syntax">struct</span><span class="plain-syntax"> </span><span class="type-syntax">C_supported_opcode</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="type-syntax">struct</span><span class="plain-syntax"> </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">name</span><span class="plain-syntax">; </span><span class="comment-syntax">/* including the opening |@| character */</span>
<span class="plain-syntax">    </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">store_this_operand</span><span class="plain-syntax">[</span><span class="constant-syntax">MAX_OPERANDS_IN_INTER_ASSEMBLY</span><span class="plain-syntax">];</span>
<span class="plain-syntax">    </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">vararg_operand</span><span class="plain-syntax">; </span><span class="comment-syntax">/* position of |_vararg_count| operand, or -1 if none */</span>
<span class="plain-syntax">    </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">speculative</span><span class="plain-syntax">; </span><span class="comment-syntax">/* i.e., not part of the standard supported set */</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">CLASS_DEFINITION</span>
<span class="plain-syntax">} </span><span class="type-syntax">C_supported_opcode</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>The structure C_supported_opcode is accessed in 5/com and here.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP4" class="paragraph-anchor"></a><b>&#167;4. </b>  On creation, a <a href="5-cas.html#SP3" class="internal">C_supported_opcode</a> is automatically added to the dictionary:</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">C_supported_opcode</span><span class="plain-syntax"> *</span><span class="function-syntax">CAssembly::new_opcode</span><button class="popup" onclick="togglePopup('usagePopup5')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup5">Usage of <span class="code-font"><span class="function-syntax">CAssembly::new_opcode</span></span>:<br/><a href="5-cas.html#SP5_1">&#167;5.1</a>, <a href="5-cas.html#SP5_2">&#167;5.2</a></span></button><span class="plain-syntax">(</span><span class="type-syntax">code_generation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">name</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s1</span><span class="plain-syntax">, </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s2</span><span class="plain-syntax">, </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">va</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="type-syntax">C_supported_opcode</span><span class="plain-syntax"> *</span><span class="identifier-syntax">opc</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="type-syntax">C_supported_opcode</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">opc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">speculative</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">opc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">name</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Str::duplicate</span><span class="plain-syntax">(</span><span class="identifier-syntax">name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><span class="constant-syntax">MAX_OPERANDS_IN_INTER_ASSEMBLY</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) </span><span class="identifier-syntax">opc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">store_this_operand</span><span class="plain-syntax">[</span><span class="identifier-syntax">i</span><span class="plain-syntax">] = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">s1</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">opc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">store_this_operand</span><span class="plain-syntax">[</span><span class="identifier-syntax">s1</span><span class="plain-syntax">] = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">s2</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">opc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">store_this_operand</span><span class="plain-syntax">[</span><span class="identifier-syntax">s2</span><span class="plain-syntax">] = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">opc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">vararg_operand</span><span class="plain-syntax"> = </span><span class="identifier-syntax">va</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">Dictionaries::create</span><span class="plain-syntax">(</span><span class="identifier-syntax">C_GEN_DATA</span><span class="plain-syntax">(</span><span class="identifier-syntax">asmdata</span><span class="plain-syntax">.</span><span class="element-syntax">opcodes_used</span><span class="plain-syntax">), </span><span class="identifier-syntax">name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">Dictionaries::write_value</span><span class="plain-syntax">(</span><span class="identifier-syntax">C_GEN_DATA</span><span class="plain-syntax">(</span><span class="identifier-syntax">asmdata</span><span class="plain-syntax">.</span><span class="element-syntax">opcodes_used</span><span class="plain-syntax">), </span><span class="identifier-syntax">name</span><span class="plain-syntax">, </span><span class="identifier-syntax">opc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">opc</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP5" class="paragraph-anchor"></a><b>&#167;5. </b>  When the generator encounters an opcode called <code>name</code> which seems to be used
with <code>operand_count</code> operands, it calls the following function to find the
corresponding metadata. Note that this always returns a valid <a href="5-cas.html#SP3" class="internal">C_supported_opcode</a>,
because even if a completely unexpected name is encountered, the above
mechanism will just create a meaning for it.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">C_supported_opcode</span><span class="plain-syntax"> *</span><span class="function-syntax">CAssembly::find_opcode</span><button class="popup" onclick="togglePopup('usagePopup6')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup6">Usage of <span class="code-font"><span class="function-syntax">CAssembly::find_opcode</span></span>:<br/><a href="5-cas.html#SP6">&#167;6</a></span></button><span class="plain-syntax">(</span><span class="type-syntax">code_generation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">name</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">operand_count</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">C_GEN_DATA</span><span class="plain-syntax">(</span><span class="identifier-syntax">asmdata</span><span class="plain-syntax">.</span><span class="element-syntax">opcodes_used</span><span class="plain-syntax">) == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">C_GEN_DATA</span><span class="plain-syntax">(</span><span class="identifier-syntax">asmdata</span><span class="plain-syntax">.</span><span class="element-syntax">opcodes_used</span><span class="plain-syntax">) = </span><span class="identifier-syntax">Dictionaries::new</span><span class="plain-syntax">(256, </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-cas.html#SP5_1" class="named-paragraph-link"><span class="named-paragraph"><span class="mathjax_process">Stock with the basics</span></span><span class="named-paragraph-number">5.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="type-syntax">C_supported_opcode</span><span class="plain-syntax"> *</span><span class="identifier-syntax">opc</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Dictionaries::find</span><span class="plain-syntax">(</span><span class="identifier-syntax">C_GEN_DATA</span><span class="plain-syntax">(</span><span class="identifier-syntax">asmdata</span><span class="plain-syntax">.</span><span class="element-syntax">opcodes_used</span><span class="plain-syntax">), </span><span class="identifier-syntax">name</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">opc</span><span class="plain-syntax"> = </span><span class="identifier-syntax">Dictionaries::read_value</span><span class="plain-syntax">(</span><span class="identifier-syntax">C_GEN_DATA</span><span class="plain-syntax">(</span><span class="identifier-syntax">asmdata</span><span class="plain-syntax">.</span><span class="element-syntax">opcodes_used</span><span class="plain-syntax">), </span><span class="identifier-syntax">name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="5-cas.html#SP5_2" class="named-paragraph-link"><span class="named-paragraph"><span class="mathjax_process">Add a speculative new opcode to the dictionary</span></span><span class="named-paragraph-number">5.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">opc</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP5_1" class="paragraph-anchor"></a><b>&#167;5.1. </b> <span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Stock with the basics</span><span class="named-paragraph-number">5.1</span></span> =</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@acos"</span><span class="plain-syntax">,             </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@add"</span><span class="plain-syntax">,              </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@aload"</span><span class="plain-syntax">,            </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@aloadb"</span><span class="plain-syntax">,           </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@aloads"</span><span class="plain-syntax">,           </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@asin"</span><span class="plain-syntax">,             </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@atan"</span><span class="plain-syntax">,             </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@binarysearch"</span><span class="plain-syntax">,     </span><span class="constant-syntax">8</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@call"</span><span class="plain-syntax">,             </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">,  </span><span class="constant-syntax">2</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@ceil"</span><span class="plain-syntax">,             </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@copy"</span><span class="plain-syntax">,             </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@cos"</span><span class="plain-syntax">,              </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@div"</span><span class="plain-syntax">,              </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@exp"</span><span class="plain-syntax">,              </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@fadd"</span><span class="plain-syntax">,             </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@fdiv"</span><span class="plain-syntax">,             </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@floor"</span><span class="plain-syntax">,            </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@fmod"</span><span class="plain-syntax">,             </span><span class="constant-syntax">3</span><span class="plain-syntax">,  </span><span class="constant-syntax">4</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@fmul"</span><span class="plain-syntax">,             </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@fsub"</span><span class="plain-syntax">,             </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@ftonumn"</span><span class="plain-syntax">,          </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@ftonumz"</span><span class="plain-syntax">,          </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@gestalt"</span><span class="plain-syntax">,          </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@glk"</span><span class="plain-syntax">,              </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">,  </span><span class="constant-syntax">2</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@hasundo"</span><span class="plain-syntax">,          </span><span class="constant-syntax">1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@jeq"</span><span class="plain-syntax">,             </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@jfeq"</span><span class="plain-syntax">,            </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@jfge"</span><span class="plain-syntax">,            </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@jflt"</span><span class="plain-syntax">,            </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@jisinf"</span><span class="plain-syntax">,          </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@jisnan"</span><span class="plain-syntax">,          </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@jleu"</span><span class="plain-syntax">,            </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@jnz"</span><span class="plain-syntax">,             </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@jz"</span><span class="plain-syntax">,              </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@log"</span><span class="plain-syntax">,              </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@malloc"</span><span class="plain-syntax">,          </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@mcopy"</span><span class="plain-syntax">,           </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@mzero"</span><span class="plain-syntax">,           </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@mfree"</span><span class="plain-syntax">,           </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@mod"</span><span class="plain-syntax">,              </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@mul"</span><span class="plain-syntax">,              </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@neg"</span><span class="plain-syntax">,              </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@nop"</span><span class="plain-syntax">,             </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@numtof"</span><span class="plain-syntax">,           </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@pow"</span><span class="plain-syntax">,              </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@quit"</span><span class="plain-syntax">,            </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@random"</span><span class="plain-syntax">,           </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@restart"</span><span class="plain-syntax">,         </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@restore"</span><span class="plain-syntax">,          </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@restoreundo"</span><span class="plain-syntax">,      </span><span class="constant-syntax">1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@return"</span><span class="plain-syntax">,          </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@save"</span><span class="plain-syntax">,             </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@saveundo"</span><span class="plain-syntax">,         </span><span class="constant-syntax">1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@setiosys"</span><span class="plain-syntax">,        </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@setrandom"</span><span class="plain-syntax">,       </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@shiftl"</span><span class="plain-syntax">,           </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@sin"</span><span class="plain-syntax">,              </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@sqrt"</span><span class="plain-syntax">,             </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@streamchar"</span><span class="plain-syntax">,      </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@streamnum"</span><span class="plain-syntax">,       </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@streamunichar"</span><span class="plain-syntax">,   </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@sub"</span><span class="plain-syntax">,              </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@tan"</span><span class="plain-syntax">,              </span><span class="constant-syntax">2</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@ushiftr"</span><span class="plain-syntax">,          </span><span class="constant-syntax">3</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@verify"</span><span class="plain-syntax">,           </span><span class="constant-syntax">1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-cas.html#SP5">&#167;5</a>.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP5_2" class="paragraph-anchor"></a><b>&#167;5.2. </b>  Speculative opcodes cannot store and cannot have varargs. Also, since they
are not part of our supported set, there's no code here to implement them.
Instead we predeclare a function and simply assume that the user will have
written this function somewhere and linked it to us. For example, we might
predeclare this:</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_bandersnatch</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">v1</span><span class="plain-syntax">);</span>
</pre>
<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Add a speculative new opcode to the dictionary</span><span class="named-paragraph-number">5.2</span></span> =</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">opc</span><span class="plain-syntax"> = </span><a href="5-cas.html#SP4" class="function-link"><span class="function-syntax">CAssembly::new_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">name</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">, </span><span class="constant-syntax">-1</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">opc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">speculative</span><span class="plain-syntax"> = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="type-syntax">segmentation_pos</span><span class="plain-syntax"> </span><span class="identifier-syntax">saved</span><span class="plain-syntax"> = </span><a href="2-cg.html#SP12" class="function-link"><span class="function-syntax">CodeGen::select</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="constant-syntax">c_predeclarations_I7CGS</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">OUT</span><span class="plain-syntax"> = </span><a href="2-cg.html#SP14" class="function-link"><span class="function-syntax">CodeGen::current</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"void "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="5-cnm.html#SP4" class="function-link"><span class="function-syntax">CNamespace::mangle_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"(i7process_t *proc"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=1; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;=</span><span class="identifier-syntax">operand_count</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">", i7word_t v%d"</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">");\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="2-cg.html#SP12" class="function-link"><span class="function-syntax">CodeGen::deselect</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">saved</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-cas.html#SP5">&#167;5</a>.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP6" class="paragraph-anchor"></a><b>&#167;6. </b>  We finally have enough infrastructure to invoke a general assembly-language
instruction found in our Inter.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">CAssembly::invoke_opcode</span><button class="popup" onclick="togglePopup('usagePopup7')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup7">Usage of <span class="code-font"><span class="function-syntax">CAssembly::invoke_opcode</span></span>:<br/><a href="5-cas.html#SP1">&#167;1</a></span></button><span class="plain-syntax">(</span><span class="type-syntax">code_generator</span><span class="plain-syntax"> *</span><span class="identifier-syntax">gtr</span><span class="plain-syntax">, </span><span class="type-syntax">code_generation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">gen</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">opcode</span><span class="plain-syntax">, </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">operand_count</span><span class="plain-syntax">, </span><span class="identifier-syntax">inter_tree_node</span><span class="plain-syntax"> **</span><span class="identifier-syntax">operands</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">inter_tree_node</span><span class="plain-syntax"> *</span><span class="identifier-syntax">label</span><span class="plain-syntax">, </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">label_sense</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="type-syntax">C_supported_opcode</span><span class="plain-syntax"> *</span><span class="identifier-syntax">opc</span><span class="plain-syntax"> = </span><a href="5-cas.html#SP5" class="function-link"><span class="function-syntax">CAssembly::find_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">opcode</span><span class="plain-syntax">, </span><span class="identifier-syntax">operand_count</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">OUT</span><span class="plain-syntax"> = </span><a href="2-cg.html#SP14" class="function-link"><span class="function-syntax">CodeGen::current</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">label_sense</span><span class="plain-syntax"> != </span><span class="identifier-syntax">NOT_APPLICABLE</span><span class="plain-syntax">) </span><span class="named-paragraph-container code-font"><a href="5-cas.html#SP6_1" class="named-paragraph-link"><span class="named-paragraph"><span class="mathjax_process">Begin a branch instruction</span></span><span class="named-paragraph-number">6.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">push_store</span><span class="plain-syntax">[</span><span class="constant-syntax">MAX_OPERANDS_IN_INTER_ASSEMBLY</span><span class="plain-syntax">];</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><span class="constant-syntax">MAX_OPERANDS_IN_INTER_ASSEMBLY</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) </span><span class="identifier-syntax">push_store</span><span class="plain-syntax">[</span><span class="identifier-syntax">i</span><span class="plain-syntax">] = </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-cas.html#SP6_3" class="named-paragraph-link"><span class="named-paragraph"><span class="mathjax_process">Generate a function call</span></span><span class="named-paragraph-number">6.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">label_sense</span><span class="plain-syntax"> != </span><span class="identifier-syntax">NOT_APPLICABLE</span><span class="plain-syntax">) </span><span class="named-paragraph-container code-font"><a href="5-cas.html#SP6_2" class="named-paragraph-link"><span class="named-paragraph"><span class="mathjax_process">End a branch instruction</span></span><span class="named-paragraph-number">6.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="5-cas.html#SP6_4" class="named-paragraph-link"><span class="named-paragraph"><span class="mathjax_process">Push any stored results which need to end up on the stack</span></span><span class="named-paragraph-number">6.4</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">";\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP6_1" class="paragraph-anchor"></a><b>&#167;6.1. </b> <span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Begin a branch instruction</span><span class="named-paragraph-number">6.1</span></span> =</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"if ("</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-cas.html#SP6">&#167;6</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP6_2" class="paragraph-anchor"></a><b>&#167;6.2. </b> <span class="named-paragraph-container code-font"><span class="named-paragraph-defn">End a branch instruction</span><span class="named-paragraph-number">6.2</span></span> =</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">label_sense</span><span class="plain-syntax"> == </span><span class="identifier-syntax">FALSE</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" == FALSE"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">") goto "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">label</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"no branch label"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="2-vnl.html#SP4" class="function-link"><span class="function-syntax">Vanilla::node</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">label</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-cas.html#SP6">&#167;6</a>.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP6_3" class="paragraph-anchor"></a><b>&#167;6.3. </b>  Each instruction becomes a function call to the function implementing the
opcode in question, except that <code>@return</code> becomes the C statement <code>return</code>.
If the opcode has N operands then the function has N+1 arguments, since the
first is always the process pointer.</p>
<p>It may seem to compile slow code if we turn instructions into function calls, but</p>
<ul>
<li>assembly is not used very much in Inter code, and then not for time-sensitive
operations, and</li>
<li>the C compiler receiving the code we generate will almost certainly perform
inline optimisation to remove most of these calls anyway.</li>
</ul>
</div>
<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Generate a function call</span><span class="named-paragraph-number">6.3</span></span> =</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::eq</span><span class="plain-syntax">(</span><span class="identifier-syntax">opcode</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"@return"</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"return ("</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><a href="5-cnm.html#SP4" class="function-link"><span class="function-syntax">CNamespace::mangle_opcode</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">opcode</span><span class="plain-syntax">); </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"(proc"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">operand_count</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">", "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">operand</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">; </span><span class="identifier-syntax">operand</span><span class="plain-syntax"> &lt;= </span><span class="identifier-syntax">operand_count</span><span class="plain-syntax">; </span><span class="identifier-syntax">operand</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">operand</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">", "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">O</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><a href="2-cg.html#SP13" class="function-link"><span class="function-syntax">CodeGen::select_temporary</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">O</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="2-vnl.html#SP4" class="function-link"><span class="function-syntax">Vanilla::node</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">operands</span><span class="plain-syntax">[</span><span class="identifier-syntax">operand</span><span class="plain-syntax">-1]);</span>
<span class="plain-syntax">        </span><a href="2-cg.html#SP13" class="function-link"><span class="function-syntax">CodeGen::deselect_temporary</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">opc</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">store_this_operand</span><span class="plain-syntax">[</span><span class="identifier-syntax">operand</span><span class="plain-syntax">]) </span><span class="named-paragraph-container code-font"><a href="5-cas.html#SP6_3_2" class="named-paragraph-link"><span class="named-paragraph"><span class="mathjax_process">Generate a store operand</span></span><span class="named-paragraph-number">6.3.2</span></a></span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="named-paragraph-container code-font"><a href="5-cas.html#SP6_3_1" class="named-paragraph-link"><span class="named-paragraph"><span class="mathjax_process">Generate a regular operand</span></span><span class="named-paragraph-number">6.3.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">O</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">")"</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-cas.html#SP6">&#167;6</a>.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP6_3_1" class="paragraph-anchor"></a><b>&#167;6.3.1. </b>  The argument for a regular operand will have type <code>i7word_t</code>, so we have to
compile something of that type here.</p>
<p>The special operand notation <code>sp</code> is a pseudo-variable meaning &quot;the top of the
stack&quot;, so if we see that then we compile that to a pull: note that <code>i7_pull</code>
returns an <code>i7word_t</code>.</p>
</div>
<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Generate a regular operand</span><span class="named-paragraph-number">6.3.1</span></span> =</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::eq</span><span class="plain-syntax">(</span><span class="identifier-syntax">O</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"sp"</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"i7_pull(proc)"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">O</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-cas.html#SP6_3">&#167;6.3</a>.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP6_3_2" class="paragraph-anchor"></a><b>&#167;6.3.2. </b>  The argument for a store operand will have type <code>i7word_t *</code>, so now we have
to make a pointer.</p>
<p>Again, <code>sp</code> is a pseudo-variable meaning &quot;the top of the stack&quot;, but this time
we have to push, not pull, and that's something we can't do until the function
has returned -- the function will create the value we need to push. We get
around this by compiling a pointer to some temporary memory.</p>
<p>Finally, assembly also allows <code>0</code> as a special value for a store operand, and
this means &quot;throw the value away&quot;. We don't want to incur a C compiler warning
by attempting to write <code>0</code> in a pointer context, so we pass it as <code>NULL</code> instead.</p>
</div>
<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Generate a store operand</span><span class="named-paragraph-number">6.3.2</span></span> =</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::eq</span><span class="plain-syntax">(</span><span class="identifier-syntax">O</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"sp"</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&amp;(proc-&gt;state.tmp[%d])"</span><span class="plain-syntax">, </span><span class="identifier-syntax">operand</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">push_store</span><span class="plain-syntax">[</span><span class="identifier-syntax">operand</span><span class="plain-syntax">] = </span><span class="identifier-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">Str::eq</span><span class="plain-syntax">(</span><span class="identifier-syntax">O</span><span class="plain-syntax">, </span><span class="identifier-syntax">I</span><span class="string-syntax">"0"</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"NULL"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&amp;%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">O</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-cas.html#SP6_3">&#167;6.3</a>.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP6_4" class="paragraph-anchor"></a><b>&#167;6.4. </b>  That may leave a few stored results stranded in temporary workspace, so:</p>
</div>
<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Push any stored results which need to end up on the stack</span><span class="named-paragraph-number">6.4</span></span> =</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">operand</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">; </span><span class="identifier-syntax">operand</span><span class="plain-syntax"> &lt;= </span><span class="identifier-syntax">operand_count</span><span class="plain-syntax">; </span><span class="identifier-syntax">operand</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">push_store</span><span class="plain-syntax">[</span><span class="identifier-syntax">operand</span><span class="plain-syntax">])</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"; i7_push(proc, proc-&gt;state.tmp[%d])"</span><span class="plain-syntax">, </span><span class="identifier-syntax">operand</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="5-cas.html#SP6">&#167;6</a>.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP7" class="paragraph-anchor"></a><b>&#167;7. </b>  And where does the special operand <code>sp</code> come from? From here:</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">CAssembly::assembly_marker</span><button class="popup" onclick="togglePopup('usagePopup8')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup8">Usage of <span class="code-font"><span class="function-syntax">CAssembly::assembly_marker</span></span>:<br/><a href="5-cas.html#SP1">&#167;1</a></span></button><span class="plain-syntax">(</span><span class="type-syntax">code_generator</span><span class="plain-syntax"> *</span><span class="identifier-syntax">gtr</span><span class="plain-syntax">, </span><span class="type-syntax">code_generation</span><span class="plain-syntax"> *</span><span class="identifier-syntax">gen</span><span class="plain-syntax">, </span><span class="identifier-syntax">inter_ti</span><span class="plain-syntax"> </span><span class="identifier-syntax">marker</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">OUT</span><span class="plain-syntax"> = </span><a href="2-cg.html#SP14" class="function-link"><span class="function-syntax">CodeGen::current</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">gen</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">marker</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">ASM_SP_ASMMARKER:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"sp"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">default:</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">STDERR</span><span class="plain-syntax">, </span><span class="string-syntax">"Unsupported assembly marker is '%d'\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">marker</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"unsupported assembly marker in C"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP8" class="paragraph-anchor"></a><b>&#167;8. call.</b>  That does everything except to implement the standard set of opcodes, which
must be done with about 60 functions in the C library.</p>
<p>This is not the place to specify what Glulx opcodes do. See Andrew Plotkin's
<a href="https://www.eblong.com/zarf/glulx" class="external">documentation on the Glulx virtual machine</a>.</p>
<p>Most of the opcodes we support are defined below, but see also <a href="5-cim.html" class="internal">C Input-Output Model</a>
for <code>@glk</code>, and see <a href="5-car.html" class="internal">C Arithmetic</a> for the plethora of mathematical operations
such as <code>@fmul</code>.</p>
<p>To begin, here is a <code>@call</code>, which performs a function call to a perhaps computed
address:</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_call</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">fn_ref</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">varargc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_call</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">fn_ref</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">varargc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">args</span><span class="plain-syntax">[10]; </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;10; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) </span><span class="identifier-syntax">args</span><span class="plain-syntax">[</span><span class="identifier-syntax">i</span><span class="plain-syntax">] = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><span class="identifier-syntax">varargc</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) </span><span class="identifier-syntax">args</span><span class="plain-syntax">[</span><span class="identifier-syntax">i</span><span class="plain-syntax">] = </span><span class="identifier-syntax">i7_pull</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">rv</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i7_gen_call</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">fn_ref</span><span class="plain-syntax">, </span><span class="identifier-syntax">args</span><span class="plain-syntax">, </span><span class="identifier-syntax">varargc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">z</span><span class="plain-syntax">) *</span><span class="identifier-syntax">z</span><span class="plain-syntax"> = </span><span class="identifier-syntax">rv</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP9" class="paragraph-anchor"></a><b>&#167;9. copy.</b>  Though it doesn't look it, this is one of the main ways Glulx assembly language
programs push or pull to the stack -- <code>@copy sp x</code> pulls the stack to <code>x</code>;
<code>@copy sp 0</code> pops the stack; <code>@copy x sp</code> pushes <code>x</code> to the stack. But all of
that is handled by the general mechanism above.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_copy</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_copy</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">y</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">y</span><span class="plain-syntax">) *</span><span class="identifier-syntax">y</span><span class="plain-syntax"> = </span><span class="identifier-syntax">x</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<p class="commentary firstcommentary"><a id="SP10" class="paragraph-anchor"></a><b>&#167;10. aload, aloads, aloadb.</b> </p>

<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_aload</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_aloads</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_aloadb</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_aload</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">z</span><span class="plain-syntax">) *</span><span class="identifier-syntax">z</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i7_read_word</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_aloads</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">z</span><span class="plain-syntax">) *</span><span class="identifier-syntax">z</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i7_read_sword</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_aloadb</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">z</span><span class="plain-syntax">) *</span><span class="identifier-syntax">z</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i7_read_byte</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">x</span><span class="plain-syntax">+</span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<p class="commentary firstcommentary"><a id="SP11" class="paragraph-anchor"></a><b>&#167;11. ushiftr, shiftl.</b> </p>

<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_shiftl</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_ushiftr</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_shiftl</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">value</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">y</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">y</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">32</span><span class="plain-syntax">)) </span><span class="identifier-syntax">value</span><span class="plain-syntax"> = (</span><span class="identifier-syntax">x</span><span class="plain-syntax"> &lt;&lt; </span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">z</span><span class="plain-syntax">) *</span><span class="identifier-syntax">z</span><span class="plain-syntax"> = </span><span class="identifier-syntax">value</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_ushiftr</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">value</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">y</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">y</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">32</span><span class="plain-syntax">)) </span><span class="identifier-syntax">value</span><span class="plain-syntax"> = (</span><span class="identifier-syntax">x</span><span class="plain-syntax"> &gt;&gt; </span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">z</span><span class="plain-syntax">) *</span><span class="identifier-syntax">z</span><span class="plain-syntax"> = </span><span class="identifier-syntax">value</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP12" class="paragraph-anchor"></a><b>&#167;12. jeq, jleu, jnz, jz.</b>  These are branch opcodes and return an <code>int</code>.</p>
<p>The implementation of <code>@jleu</code> here is modelled on the one from <code>dumb-glulxe</code>.
Writing code like <code>*((i7word_t *) &amp;ux) = x</code> really makes you proud to have chosen
C as your programming language, but it works.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_jeq</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
<span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_jleu</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
<span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_jnz</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
<span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_jz</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_jeq</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">x</span><span class="plain-syntax"> == </span><span class="identifier-syntax">y</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_jleu</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">unsigned_i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">ux</span><span class="plain-syntax">, </span><span class="identifier-syntax">uy</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    *((</span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *) &amp;</span><span class="identifier-syntax">ux</span><span class="plain-syntax">) = </span><span class="identifier-syntax">x</span><span class="plain-syntax">; *((</span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *) &amp;</span><span class="identifier-syntax">uy</span><span class="plain-syntax">) = </span><span class="identifier-syntax">y</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">ux</span><span class="plain-syntax"> &lt;= </span><span class="identifier-syntax">uy</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_jnz</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">x</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_jz</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">x</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP13" class="paragraph-anchor"></a><b>&#167;13. nop, quit, verify.</b>  There is no real meaning for <code>@verify</code> in this situation: it's supposed to
check the checksum for the contents of a virtual machine, to protect against
the (entirely likely) scenario of a floppy disk sector going bad in 1983.
So we unconditionally store the &quot;okay&quot; result.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_nop</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_quit</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_verify</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_nop</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_quit</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7_fatal_exit</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_verify</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">z</span><span class="plain-syntax">) *</span><span class="identifier-syntax">z</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP14" class="paragraph-anchor"></a><b>&#167;14. restoreundo, saveundo, hasundo, discardundo.</b>  This all works, but we do something pretty inelegant to support <code>@restoreundo</code>:
we insert a call to a (presumably kit-based) function called <code>DealWithUndo</code>,
provided this exists. This is done because we are unable safely to follow the
proper Glulx specification. In principle, after a <code>@restoreundo</code> succeeds,
execution immediately continues from the position in the program where the
<code>@saveundo</code> occurred. For a while the implementation here imitated this by
using <code>longjmp</code> and <code>setjmp</code>, but it all proved very fragile because of the
difficulty of storing <code>setjmp</code> positions safely in memory.</p>
<p>Correspondingly, our implementation of <code>@saveundo</code> always stores the result
value 0. The result value 1 would indicate that execution had switched there
from a successful <code>@restoreundo</code>: but, as noted, that never happens.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_restoreundo</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_saveundo</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_hasundo</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_discardundo</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">#</span><span class="identifier-syntax">ifdef</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_mgl_DealWithUndo</span>
<span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_fn_DealWithUndo</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">#</span><span class="identifier-syntax">endif</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_restoreundo</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">x</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">i7_has_snapshot</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">i7_restore_snapshot</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">x</span><span class="plain-syntax">) *</span><span class="identifier-syntax">x</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        #</span><span class="identifier-syntax">ifdef</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_mgl_DealWithUndo</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">i7_fn_DealWithUndo</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        #</span><span class="identifier-syntax">endif</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">x</span><span class="plain-syntax">) *</span><span class="identifier-syntax">x</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_saveundo</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">x</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7_save_snapshot</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">x</span><span class="plain-syntax">) *</span><span class="identifier-syntax">x</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_hasundo</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">x</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">rv</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">i7_has_snapshot</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">)) </span><span class="identifier-syntax">rv</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">x</span><span class="plain-syntax">) *</span><span class="identifier-syntax">x</span><span class="plain-syntax"> = </span><span class="identifier-syntax">rv</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_discardundo</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7_destroy_latest_snapshot</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP15" class="paragraph-anchor"></a><b>&#167;15. restart, restore, save.</b>  For the moment, at least, we intentionally do not implement these. It seems
likely that anyone using C to run interactive fiction is doing so in a wider
framework where saved states will work differently from the traditional model
of asking the user for a filename and then saving data out to a binary file
of that name in the current working directory. Better to do nothing here, and
let users handle this themselves.</p>
<p>Similar considerations apply to <code>@restart</code>. The intention of this opcode is
essentially to reboot the virtual machine and start over: here, though, we
have a real machine. It's easy enough to reinitialise the process state,
but not so simple to restart execution as if from a clean process start.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_restart</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_restore</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_save</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_restart</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">printf</span><span class="plain-syntax">(</span><span class="string-syntax">"(RESTART is not implemented on this C program.)\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_restore</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">y</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">printf</span><span class="plain-syntax">(</span><span class="string-syntax">"(RESTORE is not implemented on this C program.)\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_save</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">y</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">printf</span><span class="plain-syntax">(</span><span class="string-syntax">"(SAVE is not implemented on this C program.)\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<p class="commentary firstcommentary"><a id="SP16" class="paragraph-anchor"></a><b>&#167;16. streamchar, streamnum, streamunichar.</b> </p>

<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_streamnum</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_streamchar</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_streamunichar</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_streamnum</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7_print_decimal</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_streamchar</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7_print_char</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_streamunichar</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7_print_char</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP17" class="paragraph-anchor"></a><b>&#167;17. binarysearch.</b>  This is a Grand Imperial Hotel among Glulx opcodes, with 8 operands, only the
last of which is a store. It performs a binary search on a block of structures
known to be sorted already. It has a nice general-purpose look but was devised so
that command verbs could be looked up quickly in dictionary tables when interactive
fiction is being played: that's the only use which the standard Inform kits make
of it.</p>
<p>The elegant implementation here comes from Andrew Plotkin's reference code for
<code>glulxe</code>, a Glulx interpreter. <code>options</code> is a bitmap of the bits defined below.
In the only use the standard Inform kits make of this opcode, <code>options</code> will be
just <code>serop_KeyIndirect</code>, but <code>keysize</code> will be more than 4, so that the elaborate
speed optimisation for keys of size 1, 2 and 4, and thus <code>keybuf</code>, are never used.
But we may as well have the full functionality here.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">#</span><span class="identifier-syntax">define</span><span class="plain-syntax"> </span><span class="identifier-syntax">serop_KeyIndirect</span><span class="plain-syntax">        </span><span class="constant-syntax">1</span>
<span class="plain-syntax">#</span><span class="identifier-syntax">define</span><span class="plain-syntax"> </span><span class="identifier-syntax">serop_ZeroKeyTerminates</span><span class="plain-syntax">  </span><span class="constant-syntax">2</span>
<span class="plain-syntax">#</span><span class="identifier-syntax">define</span><span class="plain-syntax"> </span><span class="identifier-syntax">serop_ReturnIndex</span><span class="plain-syntax">        </span><span class="constant-syntax">4</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_binarysearch</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">key</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">keysize</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">start</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">structsize</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">numstructs</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">keyoffset</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">options</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">s1</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_binarysearch</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">key</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">keysize</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">start</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">structsize</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">numstructs</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">keyoffset</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">options</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">s1</span><span class="plain-syntax">) {</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">s1</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax">; </span><span class="comment-syntax">/* Do not spend any time if the result is to be ignored */</span>


<span class="plain-syntax">    </span><span class="comment-syntax">/* If the key size is 4 or fewer, copy it directly into the keybuf array */</span>
<span class="plain-syntax">    </span><span class="type-syntax">unsigned</span><span class="plain-syntax"> </span><span class="type-syntax">char</span><span class="plain-syntax"> </span><span class="identifier-syntax">keybuf</span><span class="plain-syntax">[4];</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">options</span><span class="plain-syntax"> &amp; </span><span class="identifier-syntax">serop_KeyIndirect</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">keysize</span><span class="plain-syntax"> &lt;= </span><span class="constant-syntax">4</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">ix</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">ix</span><span class="plain-syntax">&lt;</span><span class="identifier-syntax">keysize</span><span class="plain-syntax">; </span><span class="identifier-syntax">ix</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">keybuf</span><span class="plain-syntax">[</span><span class="identifier-syntax">ix</span><span class="plain-syntax">] = </span><span class="identifier-syntax">i7_read_byte</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">key</span><span class="plain-syntax"> + </span><span class="identifier-syntax">ix</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">keysize</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">4</span><span class="plain-syntax">:</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">keybuf</span><span class="plain-syntax">[0] = </span><span class="identifier-syntax">I7BYTE_0</span><span class="plain-syntax">(</span><span class="identifier-syntax">key</span><span class="plain-syntax">); </span><span class="identifier-syntax">keybuf</span><span class="plain-syntax">[1] = </span><span class="identifier-syntax">I7BYTE_1</span><span class="plain-syntax">(</span><span class="identifier-syntax">key</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">keybuf</span><span class="plain-syntax">[2] = </span><span class="identifier-syntax">I7BYTE_2</span><span class="plain-syntax">(</span><span class="identifier-syntax">key</span><span class="plain-syntax">); </span><span class="identifier-syntax">keybuf</span><span class="plain-syntax">[3] = </span><span class="identifier-syntax">I7BYTE_3</span><span class="plain-syntax">(</span><span class="identifier-syntax">key</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">2</span><span class="plain-syntax">:</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">keybuf</span><span class="plain-syntax">[0] = </span><span class="identifier-syntax">I7BYTE_0</span><span class="plain-syntax">(</span><span class="identifier-syntax">key</span><span class="plain-syntax">); </span><span class="identifier-syntax">keybuf</span><span class="plain-syntax">[1] = </span><span class="identifier-syntax">I7BYTE_1</span><span class="plain-syntax">(</span><span class="identifier-syntax">key</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span><span class="plain-syntax">:</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">keybuf</span><span class="plain-syntax">[0] = </span><span class="identifier-syntax">key</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">bot</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">top</span><span class="plain-syntax"> = </span><span class="identifier-syntax">numstructs</span><span class="plain-syntax">; </span><span class="comment-syntax">/* Initial search range, including bot but not top */</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><span class="identifier-syntax">bot</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">top</span><span class="plain-syntax">) { </span><span class="comment-syntax">/* I.e., while the search range is not empty */</span>
<span class="plain-syntax">        </span><span class="comment-syntax">/* Find the structure at the midpoint of the search range */</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">val</span><span class="plain-syntax"> = (</span><span class="identifier-syntax">top</span><span class="plain-syntax">+</span><span class="identifier-syntax">bot</span><span class="plain-syntax">) / </span><span class="constant-syntax">2</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">addr</span><span class="plain-syntax"> = </span><span class="identifier-syntax">start</span><span class="plain-syntax"> + </span><span class="identifier-syntax">val</span><span class="plain-syntax"> * </span><span class="identifier-syntax">structsize</span><span class="plain-syntax">;</span>

<span class="plain-syntax">        </span><span class="comment-syntax">/* Compute cmp = 0 if the key matches this, -1 if it precedes, 1 if it follows */</span>
<span class="plain-syntax">        </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">cmp</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">keysize</span><span class="plain-syntax"> &lt;= </span><span class="constant-syntax">4</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">ix</span><span class="plain-syntax">=0; (!</span><span class="identifier-syntax">cmp</span><span class="plain-syntax">) &amp;&amp; </span><span class="identifier-syntax">ix</span><span class="plain-syntax">&lt;</span><span class="identifier-syntax">keysize</span><span class="plain-syntax">; </span><span class="identifier-syntax">ix</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">                </span><span class="type-syntax">unsigned</span><span class="plain-syntax"> </span><span class="type-syntax">char</span><span class="plain-syntax"> </span><span class="identifier-syntax">byte</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i7_read_byte</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">addr</span><span class="plain-syntax"> + </span><span class="identifier-syntax">keyoffset</span><span class="plain-syntax"> + </span><span class="identifier-syntax">ix</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="type-syntax">unsigned</span><span class="plain-syntax"> </span><span class="type-syntax">char</span><span class="plain-syntax"> </span><span class="identifier-syntax">byte2</span><span class="plain-syntax"> = </span><span class="identifier-syntax">keybuf</span><span class="plain-syntax">[</span><span class="identifier-syntax">ix</span><span class="plain-syntax">];</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">byte</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">byte2</span><span class="plain-syntax">) </span><span class="identifier-syntax">cmp</span><span class="plain-syntax"> = </span><span class="constant-syntax">-1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">byte</span><span class="plain-syntax"> &gt; </span><span class="identifier-syntax">byte2</span><span class="plain-syntax">) </span><span class="identifier-syntax">cmp</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">ix</span><span class="plain-syntax">=0; (!</span><span class="identifier-syntax">cmp</span><span class="plain-syntax">) &amp;&amp; </span><span class="identifier-syntax">ix</span><span class="plain-syntax">&lt;</span><span class="identifier-syntax">keysize</span><span class="plain-syntax">; </span><span class="identifier-syntax">ix</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">                </span><span class="type-syntax">unsigned</span><span class="plain-syntax"> </span><span class="type-syntax">char</span><span class="plain-syntax"> </span><span class="identifier-syntax">byte</span><span class="plain-syntax">  = </span><span class="identifier-syntax">i7_read_byte</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">addr</span><span class="plain-syntax"> + </span><span class="identifier-syntax">keyoffset</span><span class="plain-syntax"> + </span><span class="identifier-syntax">ix</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="type-syntax">unsigned</span><span class="plain-syntax"> </span><span class="type-syntax">char</span><span class="plain-syntax"> </span><span class="identifier-syntax">byte2</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i7_read_byte</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">key</span><span class="plain-syntax"> + </span><span class="identifier-syntax">ix</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">byte</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">byte2</span><span class="plain-syntax">) </span><span class="identifier-syntax">cmp</span><span class="plain-syntax"> = </span><span class="constant-syntax">-1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">byte</span><span class="plain-syntax"> &gt; </span><span class="identifier-syntax">byte2</span><span class="plain-syntax">) </span><span class="identifier-syntax">cmp</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        }</span>

<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">cmp</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="comment-syntax">/* Success! */</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">options</span><span class="plain-syntax"> &amp; </span><span class="identifier-syntax">serop_ReturnIndex</span><span class="plain-syntax">) *</span><span class="identifier-syntax">s1</span><span class="plain-syntax"> = </span><span class="identifier-syntax">val</span><span class="plain-syntax">; </span><span class="reserved-syntax">else</span><span class="plain-syntax"> *</span><span class="identifier-syntax">s1</span><span class="plain-syntax"> = </span><span class="identifier-syntax">addr</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>

<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">cmp</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">bot</span><span class="plain-syntax"> = </span><span class="identifier-syntax">val</span><span class="plain-syntax">+1; </span><span class="comment-syntax">/* Chop search range to the second half */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">top</span><span class="plain-syntax"> = </span><span class="identifier-syntax">val</span><span class="plain-syntax">; </span><span class="comment-syntax">/* Chop search range to the first half */</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><span class="comment-syntax">/* Failure! */</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">options</span><span class="plain-syntax"> &amp; </span><span class="identifier-syntax">serop_ReturnIndex</span><span class="plain-syntax">) *</span><span class="identifier-syntax">s1</span><span class="plain-syntax"> = </span><span class="constant-syntax">-1</span><span class="plain-syntax">; </span><span class="reserved-syntax">else</span><span class="plain-syntax"> *</span><span class="identifier-syntax">s1</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP18" class="paragraph-anchor"></a><b>&#167;18. mcopy, mzero, malloc, mfree.</b>  A Glulx assembly opcode is provided for fast memory copies, which we must
implement. We're choosing not to implement the Glulx <code>@malloc</code> or <code>@mfree</code>
opcodes for now, but that will surely need to change in due course. (When that
does change, we will need also to change <code>@gestalt</code>.)</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_mcopy</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">z</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_mzero</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_malloc</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_mfree</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_mcopy</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">z</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">z</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">y</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><span class="identifier-syntax">x</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">i7_write_byte</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">z</span><span class="plain-syntax">+</span><span class="identifier-syntax">i</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7_read_byte</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">y</span><span class="plain-syntax">+</span><span class="identifier-syntax">i</span><span class="plain-syntax">));</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=</span><span class="identifier-syntax">x</span><span class="plain-syntax">-1; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&gt;=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax">--)</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">i7_write_byte</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">z</span><span class="plain-syntax">+</span><span class="identifier-syntax">i</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7_read_byte</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">y</span><span class="plain-syntax">+</span><span class="identifier-syntax">i</span><span class="plain-syntax">));</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_mzero</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">i</span><span class="plain-syntax">&lt;</span><span class="identifier-syntax">x</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++) </span><span class="identifier-syntax">i7_write_byte</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">y</span><span class="plain-syntax">+</span><span class="identifier-syntax">i</span><span class="plain-syntax">, </span><span class="constant-syntax">0</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_malloc</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">printf</span><span class="plain-syntax">(</span><span class="string-syntax">"Unimplemented: i7_opcode_malloc.\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7_fatal_exit</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_mfree</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">printf</span><span class="plain-syntax">(</span><span class="string-syntax">"Unimplemented: i7_opcode_mfree.\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7_fatal_exit</span><span class="plain-syntax">(</span><span class="identifier-syntax">proc</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP19" class="paragraph-anchor"></a><b>&#167;19. random, setrandom.</b>  Note that the <code>random(...)</code> function built in to Inform is just a name for the
<code>@random</code> opcode, so we define that here too.</p>
<p>We have no convincing need for a statistically good random number algorithm,
but we do want cross-platform consistency in order that the test suite for Inform
should behave equivalently on MacOS, Linux and Windows -- at least when the
generator is seeded with the same value. To that end, we borrow the algorithm
used by the <code>frotz</code> Z-machine interpreter, which in turn is based on suggestions
in the Z-machine standards document.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="identifier-syntax">i7rngseed_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_initial_rng_seed</span><span class="plain-syntax">(</span><span class="type-syntax">void</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_random</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_setrandom</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="identifier-syntax">i7rngseed_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_initial_rng_seed</span><span class="plain-syntax">(</span><span class="type-syntax">void</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">i7rngseed_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">seed</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">A</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">interval</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">counter</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">seed</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_random</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">y</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">uint32_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">rawvalue</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">interval</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">rawvalue</span><span class="plain-syntax"> = </span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">counter</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">counter</span><span class="plain-syntax"> == </span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">interval</span><span class="plain-syntax">) </span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">counter</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">A</span><span class="plain-syntax"> = </span><span class="constant-syntax">0x015a4e35</span><span class="identifier-syntax">L</span><span class="plain-syntax"> * </span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">A</span><span class="plain-syntax"> + </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">rawvalue</span><span class="plain-syntax"> = (</span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">A</span><span class="plain-syntax"> &gt;&gt; </span><span class="constant-syntax">16</span><span class="plain-syntax">) &amp; </span><span class="constant-syntax">0x7fff</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">uint32_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">value</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">x</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">value</span><span class="plain-syntax"> = </span><span class="identifier-syntax">rawvalue</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">x</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">1</span><span class="plain-syntax">) </span><span class="identifier-syntax">value</span><span class="plain-syntax"> = </span><span class="identifier-syntax">rawvalue</span><span class="plain-syntax"> % (</span><span class="identifier-syntax">uint32_t</span><span class="plain-syntax">) (</span><span class="identifier-syntax">x</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">value</span><span class="plain-syntax"> = </span><span class="constant-syntax">-</span><span class="plain-syntax">(</span><span class="identifier-syntax">rawvalue</span><span class="plain-syntax"> % (</span><span class="identifier-syntax">uint32_t</span><span class="plain-syntax">) (-</span><span class="identifier-syntax">x</span><span class="plain-syntax">));</span>
<span class="plain-syntax">    *</span><span class="identifier-syntax">y</span><span class="plain-syntax"> = (</span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax">) </span><span class="identifier-syntax">value</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_setrandom</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">s</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">A</span><span class="plain-syntax"> = (</span><span class="identifier-syntax">uint32_t</span><span class="plain-syntax">) </span><span class="identifier-syntax">time</span><span class="plain-syntax">(</span><span class="identifier-syntax">NULL</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">interval</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">s</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">1000</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">interval</span><span class="plain-syntax"> = </span><span class="identifier-syntax">s</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">counter</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">A</span><span class="plain-syntax"> = </span><span class="identifier-syntax">s</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">proc</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">state</span><span class="plain-syntax">.</span><span class="identifier-syntax">seed</span><span class="plain-syntax">.</span><span class="identifier-syntax">interval</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP20" class="paragraph-anchor"></a><b>&#167;20. setiosys.</b>  This opcode in principle allows a story file to select the input-output system
it will use. But the Inform kits only use system 2, called Glk, and this is the
only system we support, so we will simply ignore this.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_setiosys</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_setiosys</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP21" class="paragraph-anchor"></a><b>&#167;21. gestalt.</b>  This opcode allows a story file to ask the Glulx interpreter running it whether
or not the interpreter can perform certain tasks.</p>
</div>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_gestalt</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.h.</li></ul>
<pre class="displayed-code all-displayed-code code-font">
<span class="type-syntax">void</span><span class="plain-syntax"> </span><span class="identifier-syntax">i7_opcode_gestalt</span><span class="plain-syntax">(</span><span class="identifier-syntax">i7process_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">proc</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">x</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">y</span><span class="plain-syntax">, </span><span class="identifier-syntax">i7word_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">z</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="type-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">x</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">0</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">0x00030103</span><span class="plain-syntax">; </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* Say that the Glulx version is v3.1.3 */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;          </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* Say that the interpreter version is 1 */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">2</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;          </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* We do not (yet) support @setmemsize */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">3</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;          </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* We do support UNDO */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">4</span><span class="plain-syntax">: </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">y</span><span class="plain-syntax"> == </span><span class="constant-syntax">2</span><span class="plain-syntax">) </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;     </span><span class="comment-syntax">/* We do support Glk */</span>
<span class="plain-syntax">                       </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;     </span><span class="comment-syntax">/* But not any other I/O system */</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">5</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;          </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* We do support Unicode operations */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">6</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;          </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* We do support @mzero and @mcopy */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">7</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;          </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* We do not (yet) support @malloc or @mfree */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">8</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;          </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* Since we do not support @malloc */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">9</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;          </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* We do not support @accelfunc pr @accelparam */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">10</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;         </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* And therefore provide none of their accelerants */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">11</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;         </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* We do support floating-point maths operations */</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">12</span><span class="plain-syntax">: </span><span class="identifier-syntax">r</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;         </span><span class="reserved-syntax">break</span><span class="plain-syntax">; </span><span class="comment-syntax">/* We do support @hasundo and @discardundo */</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">z</span><span class="plain-syntax">) *</span><span class="identifier-syntax">z</span><span class="plain-syntax"> = </span><span class="identifier-syntax">r</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>This is part of the extract file inform7_clib.c.</li></ul>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="5-cmm.html">&#10094;</a></li><li class="progresschapter"><a href="P-wtmd.html">P</a></li><li class="progresschapter"><a href="1-fm.html">1</a></li><li class="progresschapter"><a href="2-cg.html">2</a></li><li class="progresschapter"><a href="3-fti.html">3</a></li><li class="progresschapter"><a href="4-fi6.html">4</a></li><li class="progresscurrentchapter">5</li><li class="progresssection"><a href="5-fnc.html">fnc</a></li><li class="progresssection"><a href="5-cnm.html">cnm</a></li><li class="progresssection"><a href="5-crf.html">crf</a></li><li class="progresssection"><a href="5-cgv.html">cgv</a></li><li class="progresssection"><a href="5-cmm.html">cmm</a></li><li class="progresscurrent">cas</li><li class="progresssection"><a href="5-car.html">car</a></li><li class="progresssection"><a href="5-cpc.html">cpc</a></li><li class="progresssection"><a href="5-ccn.html">ccn</a></li><li class="progresssection"><a href="5-clt.html">clt</a></li><li class="progresssection"><a href="5-com.html">com</a></li><li class="progresssection"><a href="5-cfm.html">cfm</a></li><li class="progresssection"><a href="5-cim.html">cim</a></li><li class="progresssection"><a href="5-cmn.html">cmn</a></li><li class="progresssection"><a href="5-cuf.html">cuf</a></li><li class="progressnext"><a href="5-car.html">&#10095;</a></li></ul></div>
</nav><!-- End of weave -->

		</main>
	</body>
</html>

