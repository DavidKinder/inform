<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>What This Module Does</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script src="http://code.jquery.com/jquery-1.12.4.min.js"
	integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>

<script src="../docs-assets/Bigfoot.js"></script>
<link href="../docs-assets/Bigfoot.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<h1><a href="../index.html"><img src="../docs-assets/Inform.png" height=72> </a></h1>
<ul><li><a href="../index.html">home</a></li>
</ul><h2>Compiler</h2><ul>
<li><a href="../structure.html">structure</a></li>
<li><a href="../inbuildn.html">inbuild</a></li>
<li><a href="../inform7n.html">inform7</a></li>
<li><a href="../intern.html">inter</a></li>
<li><a href="../services.html">services</a></li>
<li><a href="../secrets.html">secrets</a></li>
</ul><h2>Other Tools</h2><ul>
<li><a href="../inblorbn.html">inblorb</a></li>
<li><a href="../inform6.html">inform6</a></li>
<li><a href="../inpolicyn.html">inpolicy</a></li>
</ul><h2>Resources</h2><ul>
<li><a href="../extensions.html">extensions</a></li>
<li><a href="../kits.html">kits</a></li>
</ul><h2>Repository</h2><ul>
<li><a href="https://github.com/ganelson/inform"><img src="../docs-assets/github.png" height=0> github</a></li>
</ul><h2>Related Projects</h2><ul>
<li><a href="https://github.com/ganelson/inweb"><img src="../docs-assets/github.png" height=0> inweb</a></li>
<li><a href="https://github.com/ganelson/intest"><img src="../docs-assets/github.png" height=0> intest</a></li>
</ul>
		</nav>
		<main role="main">
		<!-- Weave of 'What This Module Does' generated by inweb -->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="../services.html">Services</a></li><li><a href="index.html">lexicon</a></li><li><a href="index.html#P">Preliminaries</a></li><li><b>What This Module Does</b></li></ul></div>
<p class="purpose">An overview of the lexicon module's role and abilities.</p>

<ul class="toc"><li><a href="P-wtmd.html#SP1">&#167;1. Prerequisites</a></li><li><a href="P-wtmd.html#SP2">&#167;2. A symbols table for natural language</a></li><li><a href="P-wtmd.html#SP4">&#167;4. Optimisations</a></li><li><a href="P-wtmd.html#SP6">&#167;6. Performance in practice</a></li></ul><hr class="tocbar">

<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. Prerequisites.</b>  The lexicon module is a part of the Inform compiler toolset. It is
presented as a literate program or &quot;web&quot;. Before diving in:</p>
<ul>
<li>It helps to have some experience of reading webs: see <a href="../inweb/index.html" class="internal">inweb</a> for more.</li>
<li>The module is written in C, in fact ANSI C99, but this is disguised by the
fact that it uses some extension syntaxes provided by the <a href="../inweb/index.html" class="internal">inweb</a> literate
programming tool, making it a dialect of C called InC. See <a href="../inweb/index.html" class="internal">inweb</a> for
full details, but essentially: it's C without predeclarations or header files,
and where functions have names like <code>Tags::add_by_name</code> rather than <code>add_by_name</code>.</li>
<li>This module uses other modules drawn from the compiler (see <a href="../structure.html" class="internal">structure</a>), and also
uses a module of utility functions called <a href="../foundation/index.html" class="internal">foundation</a>.
For more, see <a href="../foundation/P-abgtf.html" class="internal">A Brief Guide to Foundation (in foundation)</a>.</li>
</ul>
</div>
<p class="commentary firstcommentary"><a id="SP2" class="paragraph-anchor"></a><b>&#167;2. A symbols table for natural language.</b> </p>

<blockquote>
    <p>american dialect, say close bracket, player's command, open, Hall of Mirrors</p>
</blockquote>

<div class="lsmarkdown">
<p>This module provides an analogue to the &quot;symbols table&quot; used in a compiler for
a conventional language. For example, in a C compiler, identifiers such as
<code>int</code>, <code>x</code> or <code>printf</code> might all be entries in such a table, and any new name
can rapidly be checked to see if it matches one already known.</p>
<p>In natural language we have &quot;excerpts&quot;, that is, contiguous runs of words,
rather than identifiers. But we must similarly remember their meanings.
Examples might include:</p>
</div>
<div class="lsmarkdown">
<p>Conventional symbols table algorithms depend on the fact that identifiers are
relatively long sequences of letters (often 8 or more units) drawn from a
small alphabet (say, the 37 letters, digits and the underscore). But Inform
has short symbols (typically 1 to 3 units) drawn from a huge alphabet (say,
5,000 different words found in the source text). Inform also allows for
flexibility in matching: the excerpt meaning <code>give # bone</code>, for example, must
match &quot;give a dog a bone&quot; or &quot;give me the thigh bone&quot;.</p>
<p>We also need to parse in ways which a conventional compiler does not. If C has
registered the identifier <code>pink_martini</code>, it never needs to notice <code>martini</code> as
being related to it. But when Inform registers &quot;pink martini&quot; as the name of an
instance, it then has to spot that either &quot;pink&quot; or &quot;martini&quot; alone might also
refer to the same object.</p>
<p>Finally, we have to cope with ambiguities. An innocent word like &quot;door&quot; might
have multiple meanings, and the more so once multi-word flexible patterns
are involved.</p>
</div>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP3" class="paragraph-anchor"></a><b>&#167;3. </b>  This is not a large module, but it contains tricky and speed-critical code.
In compensation, it exposes a very simple API to the outside world, all of
which is found in <a href="1-lxc.html" class="internal">Lexicon (in lexicon)</a>.</p>
<p>The lexicon is stored using <a href="2-em.html#SP1" class="internal">excerpt_meaning</a> objects, in <a href="2-em.html" class="internal">Excerpt Meanings</a>.
Entries are added with <a href="1-lxc.html#SP1" class="internal">Lexicon::register</a> and retrieved with <a href="1-lxc.html#SP3" class="internal">Lexicon::retrieve</a>.</p>
<p>In either case the user must supply a &quot;meaning code&quot;, such as <code>TABLE_MC</code>, giving
a very loose idea of the context; we will use that both to make lookups faster,
to provide separate namespaces (one can search for just <code>TABLE_MC</code> meanings,
for example), and to control the style of parsing done.
See <a href="P-htitm.html" class="internal">How To Include This Module (in lexicon)</a>.</p>
</div>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP4" class="paragraph-anchor"></a><b>&#167;4. Optimisations.</b>  This is a speed-critical part of Inform and has been heavily optimised, at the
cost of some complexity. There are two main ideas:</p>
<p>Firstly, each word in the vocabulary gathered up by the <a href="../words-module/index.html" class="internal">words</a> module --
i.e., each different word in the source text -- has a <a href="2-em.html#SP3" class="internal">vocabulary_lexicon_data</a>
object attached to it. This in turn contains lists of all known meanings
starting with, ending with, or simply involving the word.</p>
<p>For example, if &quot;great green dragon&quot; is given a meaning, then this is added to
the first-word list for &quot;great&quot;, the last-word list for &quot;dragon&quot;, and the
middle-word list for &quot;green&quot;.</p>
<p>In addition, every word in an excerpt which is not an article adds the meaning
to its &quot;subset list&quot; -- here, that would be all three words, but for &quot;gandalf
the grey&quot;, it would be entered onto the subset lists for &quot;gandalf&quot; and &quot;grey&quot;.
Subset lists tend to be longer and thus slower to deal with, and are used only
in contexts where it is legal to use a subset of a name to refer to the
meaning -- for example, to say just &quot;Gandalf&quot; but mean the same wizard.</p>
</div>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP5" class="paragraph-anchor"></a><b>&#167;5. </b>  Secondly, recall that each vocabulary entry has a field 32 bits wide for
a bitmap, of which only 6 bits were used in the lexer. (See <a href="../words-module/2-vcb.html" class="internal">Vocabulary (in words)</a>.)
For example, cardinal numbers had the <code>NUMBER_MC</code> bit set.</p>
<p>We're now going to use the other 26 bits. The idea is that if a meaning is
registered for the name of, say, a table, then the <code>TABLE_MC</code> bit would be
set for each of the words in that name. For example, if &quot;table of tides&quot; is
such a name, then each if the words <code>table</code>, <code>of</code> and <code>tides</code> picks up the
<code>TABLE_MC</code> bit.</p>
<p>What we gain by this is that if we are ever testing some words in the source
text to see if they might be the name of a table, we can immediately reject,
say, &quot;green table&quot; because the word <code>green</code> does not have the <code>TABLE_MC</code> bit.</p>
<p>For more on this, and for complications arising to do with case sensitivity,
see <a href="2-em.html#SP9" class="internal">ExcerptMeanings::hash_code_from_token_list</a>.</p>
</div>
<div class="lsmarkdown">
<p class="commentary firstcommentary"><a id="SP6" class="paragraph-anchor"></a><b>&#167;6. Performance in practice.</b>  The following statistics show how many times the lexicon was used during
a typical Inform 7 compilation (the same one used to generate the data in
<a href="../inform7/M-pm.html" class="internal">Performance Metrics (in inform7)</a>).</p>
<ul>
<li>
<p>Optimisation is worthwhile if the number of attempts with incorrect hash codes
is appreciably larger than the number with correct ones; and</p>
</li>
<li>
<p>Optimisation is efficient if the number of attempts with correct hash codes is
close to the number of successes.</p>
</li>
</ul>
</div>
<pre class="undisplayed-code all-displayed-code code-font">
<span class="identifier-syntax">Size</span><span class="plain-syntax"> </span><span class="identifier-syntax">of</span><span class="plain-syntax"> </span><span class="identifier-syntax">lexicon:</span><span class="plain-syntax"> </span><span class="constant-syntax">3658</span><span class="plain-syntax"> </span><span class="identifier-syntax">excerpt</span><span class="plain-syntax"> </span><span class="identifier-syntax">meanings</span>
<span class="plain-syntax">  </span><span class="identifier-syntax">Stored</span><span class="plain-syntax"> </span><span class="identifier-syntax">among</span><span class="plain-syntax"> </span><span class="constant-syntax">940</span><span class="plain-syntax"> </span><span class="identifier-syntax">words</span><span class="plain-syntax"> </span><span class="identifier-syntax">out</span><span class="plain-syntax"> </span><span class="identifier-syntax">of</span><span class="plain-syntax"> </span><span class="identifier-syntax">total</span><span class="plain-syntax"> </span><span class="identifier-syntax">vocabulary</span><span class="plain-syntax"> </span><span class="identifier-syntax">of</span><span class="plain-syntax"> </span><span class="constant-syntax">10998</span>
<span class="plain-syntax">  </span><span class="constant-syntax">803</span><span class="plain-syntax"> </span><span class="identifier-syntax">words</span><span class="plain-syntax"> </span><span class="identifier-syntax">have</span><span class="plain-syntax"> </span><span class="identifier-syntax">a</span><span class="plain-syntax"> </span><span class="identifier-syntax">start</span><span class="plain-syntax"> </span><span class="identifier-syntax">list:</span><span class="plain-syntax"> </span><span class="identifier-syntax">longest</span><span class="plain-syntax"> </span><span class="identifier-syntax">belongs</span><span class="plain-syntax"> </span><span class="identifier-syntax">to</span><span class="plain-syntax"> </span><span class="identifier-syntax">report</span><span class="plain-syntax"> (</span><span class="identifier-syntax">with</span><span class="plain-syntax"> </span><span class="constant-syntax">296</span><span class="plain-syntax"> </span><span class="identifier-syntax">meanings</span><span class="plain-syntax">)</span>
<span class="plain-syntax">  </span><span class="constant-syntax">23</span><span class="plain-syntax"> </span><span class="identifier-syntax">words</span><span class="plain-syntax"> </span><span class="identifier-syntax">have</span><span class="plain-syntax"> </span><span class="identifier-syntax">an</span><span class="plain-syntax"> </span><span class="identifier-syntax">end</span><span class="plain-syntax"> </span><span class="identifier-syntax">list:</span><span class="plain-syntax"> </span><span class="identifier-syntax">longest</span><span class="plain-syntax"> </span><span class="identifier-syntax">belongs</span><span class="plain-syntax"> </span><span class="identifier-syntax">to</span><span class="plain-syntax"> </span><span class="identifier-syntax">digits</span><span class="plain-syntax"> (</span><span class="identifier-syntax">with</span><span class="plain-syntax"> </span><span class="constant-syntax">7</span><span class="plain-syntax"> </span><span class="identifier-syntax">meanings</span><span class="plain-syntax">)</span>
<span class="plain-syntax">  </span><span class="constant-syntax">29</span><span class="plain-syntax"> </span><span class="identifier-syntax">words</span><span class="plain-syntax"> </span><span class="identifier-syntax">have</span><span class="plain-syntax"> </span><span class="identifier-syntax">a</span><span class="plain-syntax"> </span><span class="identifier-syntax">middle</span><span class="plain-syntax"> </span><span class="identifier-syntax">list:</span><span class="plain-syntax"> </span><span class="identifier-syntax">longest</span><span class="plain-syntax"> </span><span class="identifier-syntax">belongs</span><span class="plain-syntax"> </span><span class="identifier-syntax">to</span><span class="plain-syntax"> </span><span class="identifier-syntax">matches</span><span class="plain-syntax"> (</span><span class="identifier-syntax">with</span><span class="plain-syntax"> </span><span class="constant-syntax">6</span><span class="plain-syntax"> </span><span class="identifier-syntax">meanings</span><span class="plain-syntax">)</span>
<span class="plain-syntax">  </span><span class="constant-syntax">111</span><span class="plain-syntax"> </span><span class="identifier-syntax">words</span><span class="plain-syntax"> </span><span class="identifier-syntax">have</span><span class="plain-syntax"> </span><span class="identifier-syntax">a</span><span class="plain-syntax"> </span><span class="identifier-syntax">subset</span><span class="plain-syntax"> </span><span class="identifier-syntax">list:</span><span class="plain-syntax"> </span><span class="identifier-syntax">longest</span><span class="plain-syntax"> </span><span class="identifier-syntax">belongs</span><span class="plain-syntax"> </span><span class="identifier-syntax">to</span><span class="plain-syntax"> </span><span class="identifier-syntax">street</span><span class="plain-syntax"> (</span><span class="identifier-syntax">with</span><span class="plain-syntax"> </span><span class="constant-syntax">4</span><span class="plain-syntax"> </span><span class="identifier-syntax">meanings</span><span class="plain-syntax">)</span>

<span class="identifier-syntax">Number</span><span class="plain-syntax"> </span><span class="identifier-syntax">of</span><span class="plain-syntax"> </span><span class="identifier-syntax">attempts</span><span class="plain-syntax"> </span><span class="identifier-syntax">to</span><span class="plain-syntax"> </span><span class="identifier-syntax">retrieve:</span><span class="plain-syntax"> </span><span class="constant-syntax">113767</span>
<span class="plain-syntax">  </span><span class="identifier-syntax">of</span><span class="plain-syntax"> </span><span class="identifier-syntax">which</span><span class="plain-syntax"> </span><span class="identifier-syntax">unsuccessful:</span><span class="plain-syntax"> </span><span class="constant-syntax">94837</span>
<span class="plain-syntax">  </span><span class="identifier-syntax">of</span><span class="plain-syntax"> </span><span class="identifier-syntax">which</span><span class="plain-syntax"> </span><span class="identifier-syntax">successful:</span><span class="plain-syntax"> </span><span class="constant-syntax">18930</span>

<span class="identifier-syntax">Total</span><span class="plain-syntax"> </span><span class="identifier-syntax">attempts</span><span class="plain-syntax"> </span><span class="identifier-syntax">to</span><span class="plain-syntax"> </span><span class="identifier-syntax">match</span><span class="plain-syntax"> </span><span class="identifier-syntax">against</span><span class="plain-syntax"> </span><span class="identifier-syntax">excerpt</span><span class="plain-syntax"> </span><span class="identifier-syntax">meanings:</span><span class="plain-syntax"> </span><span class="constant-syntax">378756</span>
<span class="plain-syntax">  </span><span class="identifier-syntax">of</span><span class="plain-syntax"> </span><span class="identifier-syntax">which</span><span class="plain-syntax">, </span><span class="identifier-syntax">total</span><span class="plain-syntax"> </span><span class="identifier-syntax">with</span><span class="plain-syntax"> </span><span class="identifier-syntax">incorrect</span><span class="plain-syntax"> </span><span class="identifier-syntax">hash</span><span class="plain-syntax"> </span><span class="identifier-syntax">codes:</span><span class="plain-syntax"> </span><span class="constant-syntax">354833</span>
<span class="plain-syntax">  </span><span class="identifier-syntax">of</span><span class="plain-syntax"> </span><span class="identifier-syntax">which</span><span class="plain-syntax">, </span><span class="identifier-syntax">total</span><span class="plain-syntax"> </span><span class="identifier-syntax">with</span><span class="plain-syntax"> </span><span class="identifier-syntax">correct</span><span class="plain-syntax"> </span><span class="identifier-syntax">hash</span><span class="plain-syntax"> </span><span class="identifier-syntax">codes:</span><span class="plain-syntax"> </span><span class="constant-syntax">23923</span>
<span class="plain-syntax">  </span><span class="identifier-syntax">of</span><span class="plain-syntax"> </span><span class="identifier-syntax">which</span><span class="plain-syntax">, </span><span class="identifier-syntax">total</span><span class="plain-syntax"> </span><span class="identifier-syntax">which</span><span class="plain-syntax"> </span><span class="identifier-syntax">matched:</span><span class="plain-syntax"> </span><span class="constant-syntax">20714</span>
</pre>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprevoff">&#10094;</li><li class="progresscurrentchapter">P</li><li class="progresscurrent">wtmd</li><li class="progresssection"><a href="P-htitm.html">htitm</a></li><li class="progresschapter"><a href="1-lm.html">1</a></li><li class="progresschapter"><a href="2-em.html">2</a></li><li class="progressnext"><a href="P-htitm.html">&#10095;</a></li></ul></div>
</nav><!-- End of weave -->

		</main>
	</body>
</html>

